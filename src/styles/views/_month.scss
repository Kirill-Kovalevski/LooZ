/* ===== Month view (clean, centered, mobile-tuned) ===== */

:root{
  /* defaults, will be overridden by Settings via localStorage on boot */
  --task-pill-bg:     #FFE067;
  --task-pill-border: #f3c340;

  /* sizing tokens (safe for iPhone 12 Pro and above) */
  --month-cell-radius: 16px;
  --month-ring-thickness: 3px;
  --month-gap-x: clamp(6px, 1.6vw, 10px);
  --month-gap-y: clamp(10px, 2.6vw, 14px); /* extra vertical room so pills never touch other cells */
  --month-pill-size: clamp(22px, 5.5vw, 26px);
  --month-num-size: clamp(16px, 4.2vw, 18px);
}

body[data-view='month'] {

  /* Wrapper card (glass + pastel blobs, no overflow) */
  .p-monthview{
    position: relative;
    overflow: hidden;
    isolation: isolate;

    max-inline-size: var(--phone-w, 390px); /* iPhone 12 Pro = 390 */
    margin-inline: auto;
    margin-block: .25rem 1rem;
    padding: .75rem .75rem 1rem;
    border-radius: 16px;

    background: rgba(255,255,255,.86);
    border: 1px solid rgba(100,116,139,.14);
    box-shadow: 0 10px 26px rgba(15,23,42,.08);

    /* 1) Base wash + big soft blobs (static) */
    &::before{
      content:"";
      position:absolute; inset:-12%;
      z-index:-1;
      filter: blur(.5px);
      pointer-events:none;
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(245,248,255,.08)),
        radial-gradient(38% 38% at 10% 8%,  rgba(255,208,160,.55) 0%, rgba(255,208,160,.20) 40%, rgba(255,208,160,0) 62%),
        radial-gradient(42% 42% at 92% 6%,  rgba(176,206,255,.45) 0%, rgba(176,206,255,.18) 45%, rgba(176,206,255,0) 62%),
        radial-gradient(55% 55% at 100% 55%, rgba(205,180,255,.35) 0%, rgba(205,180,255,.12) 44%, rgba(205,180,255,0) 64%),
        radial-gradient(60% 60% at 0% 100%,  rgba(255,206,170,.36) 0%, rgba(255,206,170,.14) 45%, rgba(255,206,170,0) 70%);
    }

    /* 2) Floating blobs (very subtle motion) */
    &::after{
      content:"";
      position:absolute; inset:-20%;
      z-index:-1;
      filter: blur(28px);
      opacity:.85;
      pointer-events:none;
      background:
        radial-gradient(22% 22% at 18% 25%,  #ffe7b8 0%,  rgba(255,231,184,0) 70%),
        radial-gradient(18% 18% at 78% 22%,  #d6e2ff 0%,  rgba(214,226,255,0) 70%),
        radial-gradient(24% 24% at 78% 78%,  #e2ccff 0%,  rgba(226,204,255,0) 70%),
        radial-gradient(20% 20% at 22% 82%,  #ffd9c0 0%,  rgba(255,217,192,0) 70%);
      animation: pastel-drift 26s ease-in-out infinite alternate;
      will-change: transform, opacity;
    }
  }

  /* Title row (centered) */
  .p-monthhead{
    display: grid; place-items: center;
    margin-block: .35rem .5rem;
    .p-monthtitle{
      text-align:center;
      font: 800 16px/1.2 'Rubik', system-ui, sans-serif;
      color:#0f172a; letter-spacing:.3px;
    }
  }

  /* Weekday bar (one-piece) */
  .p-weekbar{
    display:grid; grid-template-columns:repeat(7, minmax(0,1fr));
    column-gap: var(--month-gap-x);
    row-gap: calc(var(--month-gap-y) * .6);
    margin-bottom:.6rem; direction: rtl; /* Sunday at right for Hebrew */
    background: rgba(255,255,255,.82);
    border: 1px solid #e6eeff; border-radius: 14px; padding: .5rem .35rem;

    .p-wday{ text-align:center; font:700 11px/1.1 system-ui, sans-serif; color:#64748b; }
  }

  /* Grid of dates */
  .p-monthgrid{
    display:grid; grid-template-columns:repeat(7, 1fr);
    column-gap: var(--month-gap-x);
    row-gap: var(--month-gap-y);
    direction: rtl;
  }

  /* Date cell = touch-safe square (≥44px) */
  .p-cell{
    position:relative; display:grid; place-items:center; aspect-ratio:1 / 1;
    min-inline-size: 44px; min-block-size: 44px; /* Apple HIG touch target */
    border-radius: var(--month-cell-radius);
    border:1px solid #dbe6ff; background: rgba(255,255,255,.88);
    box-shadow:0 3px 10px rgba(15,23,42,.06);
    transition: box-shadow .12s ease, transform .08s ease, border-color .12s ease;
    &:focus-visible{ outline:2px solid #93c5fd; outline-offset:2px; }
  }

  .p-cell__num{
    font: 800 var(--month-num-size)/1 'Rubik', system-ui, sans-serif;
    color:#0f172a; translate:0 2px;
  }

  /* Task counter pill — now INSIDE the cell so it never touches neighbors */
  .p-count{
    position:absolute; top:6px; left:50%; translate:-50% 0;
    inline-size: var(--month-pill-size); block-size: var(--month-pill-size); border-radius:999px;
    display:grid; place-items:center;
    font:800 12px/1 'Rubik', system-ui, sans-serif;
    background: var(--task-pill-bg, #FFE067);
    border: 1px solid var(--task-pill-border, #f3c340);
    color:#0f172a;
    box-shadow:0 3px 8px rgba(15,23,42,.08);
    pointer-events:none; opacity:.92;
    z-index: 1;
  }
  .p-count:not(.has){ opacity:.45; }

  /* TODAY ring = exactly the cell’s size (same footprint) */
  .p-cell--today::after{
    content:"";
    position:absolute;
    inset:0; /* ring matches cell size */
    border-radius: var(--month-cell-radius);
    box-shadow: 0 0 0 var(--month-ring-thickness) #ff5a3c inset; /* tomato/red ring */
    pointer-events:none;
    z-index: 0; /* under pill */
  }

  /* Dim filler days */
  .p-cell--dim{ opacity:.45; }

  @media (min-width: 430px){
    .p-monthview{ max-inline-size: 430px; }
    .p-cell__num{ font-size: clamp(18px, 4vw, 20px); }
    :root{ --month-pill-size: 28px; }
  }
}

/* ---- Motion for blobs (disabled for reduced motion) ---- */
@keyframes pastel-drift{
  0%{transform: translate3d(0,0,0) scale(1.00);}
  50%{transform: translate3d(2%, -1%, 0) scale(1.03);}
  100%{transform: translate3d(-2%, 1.5%, 0) scale(1.02);}
}
@media (prefers-reduced-motion: reduce){
  body[data-view='month'] .p-monthview::after{ animation: none; }
}

/* ===== Dark mode ===== */
:is(html,body).is-dark body[data-view='month'] {
  .p-monthview{
    background: rgba(14,18,30,.92);
    border-color: rgba(148,163,184,.18);
    box-shadow: 0 14px 36px rgba(0,0,0,.45);
    &::before{
      background:
        linear-gradient(180deg, rgba(16,20,34,.18), rgba(14,18,30,.14)),
        radial-gradient(38% 38% at 10% 8%,  rgba(255,208,160,.30) 0%, rgba(255,208,160,0) 62%),
        radial-gradient(42% 42% at 92% 6%,   rgba(176,206,255,.28) 0%, rgba(176,206,255,0) 62%),
        radial-gradient(55% 55% at 100% 55%, rgba(205,180,255,.22) 0%, rgba(205,180,255,0) 64%),
        radial-gradient(60% 60% at 0% 100%,  rgba(255,206,170,.24) 0%, rgba(255,206,170,0) 70%);
    }
    &::after{ opacity:.7; }
  }

  .p-monthhead .p-monthtitle{ color:#e6edff; }

  .p-weekbar{
    background: linear-gradient(180deg, #111827, #0b1220);
    border-color:#304469;
    .p-wday{ color:#9bb7df; }
  }

  .p-cell{
    border-color:#354a7a;
    background: rgba(16,24,40,.88);
    box-shadow:0 3px 14px rgba(6,10,22,.55);
  }
  .p-cell__num{ color:#e6edff; }

  /* Keep same CSS vars -> consistent pill colors */
  .p-count{
    background: var(--task-pill-bg, #FFE067);
    border: 1px solid var(--task-pill-border, #f3c340);
    color:#0f172a;
    box-shadow:0 4px 12px rgba(0,0,0,.45);
  }

  .p-cell--today::after{
    box-shadow: 0 0 0 var(--month-ring-thickness) #ff6a55 inset;
  }
}

/* (legacy) remove unused old tokens to avoid confusion
.task-counter{ background: var(--pills-bg); border:1px solid var(--pills-br); }
*/
/* 1) Add/adjust tokens */
:root{
  --task-pill-bg:     #FFE067;
  --task-pill-border: #f3c340;

  --month-cell-radius: 16px;
  --month-ring-thickness: 3px;

  /* spacing tuned for iPhone 12 Pro+ */
  --month-gap-x: clamp(6px, 1.6vw, 10px);
  --month-gap-y: clamp(10px, 2.6vw, 14px);

  /* pill sizing + clearance from neighbor row */
  --month-pill-size: clamp(22px, 5.5vw, 26px);
  --month-pill-clear: 6px; /* extra breathing room */
}

/* 2) Ensure the grid leaves space for the pill that protrudes upward */
body[data-view='month'] .p-monthgrid{
  display:grid;
  grid-template-columns:repeat(7, 1fr);
  column-gap: var(--month-gap-x);
  /* base gap + half the pill + a little clearance */
  row-gap: calc(var(--month-gap-y) + (var(--month-pill-size) / 2) + var(--month-pill-clear));
  direction: rtl;
}

/* 3) Position the pill right on the top edge (outside the square) */
body[data-view='month'] .p-count{
  position:absolute;
  top:0;                 /* sit on the top border */
  left:50%;
  translate:-50% -50%;   /* center on top edge */
  inline-size: var(--month-pill-size);
  block-size: var(--month-pill-size);
  border-radius: 999px;
  display:grid; place-items:center;
  font:800 12px/1 'Rubik', system-ui, sans-serif;
  background: var(--task-pill-bg, #FFE067);
  border: 1px solid var(--task-pill-border, #f3c340);
  color:#0f172a;
  box-shadow:0 3px 8px rgba(15,23,42,.08);
  pointer-events:none; opacity:.92;
  z-index: 2;           /* above the cell */
}
body[data-view='month'] .p-count:not(.has){ opacity:.45; }

/* 4) Keep the today ring strictly inside the square */
body[data-view='month'] .p-cell--today::after{
  content:"";
  position:absolute;
  inset:0; /* ring matches cell size */
  border-radius: var(--month-cell-radius);
  box-shadow: 0 0 0 var(--month-ring-thickness) #ff5a3c inset;
  pointer-events:none;
  z-index: 1; /* under the pill */
}

/* 5) (optional) Slightly raise the number so it doesn't feel crowded */
body[data-view='month'] .p-cell__num{ translate:0 1px; }
/* ============= Tokens (add this once) ============= */
:root{
  /* ...your existing tokens... */
  --month-cell-bg: rgba(255,255,255,.88); /* used for pill halo in light */
}

/* In dark mode, override the cell bg token */
:is(html,body).is-dark{
  --month-cell-bg: rgba(16,24,40,.88);
}

/* ============= Cell uses the token (keep your rule, tweak bg) ============= */
body[data-view='month'] .p-cell{
  /* ...existing props... */
  background: var(--month-cell-bg);
}

/* ============= Pill: top edge + HALO + better zero style ============= */
body[data-view='month'] .p-count{
  /* your current positioning */
  top:0; left:50%; translate:-50% -50%;
  /* HALO: paints a 3px ring of the cell bg behind the pill */
  box-shadow:
    0 0 0 3px var(--month-cell-bg),     /* <- halo that “erases” the red ring */
    0 3px 8px rgba(15,23,42,.08);       /* existing soft shadow */
  z-index: 2;                            /* above the red ring */
}

/* When there are no tasks (your code used :not(.has)), keep it solid & readable */
body[data-view='month'] .p-count:not(.has){
  opacity: 1;                            /* don’t fade the whole pill */
  background: #fff;                      /* crisp surface for readability */
  border-color: #cbd5e1;
  color: #475569;
  font-weight: 800;
}

/* Dark-mode zero style (still very readable) */
:is(html,body).is-dark body[data-view='month'] .p-count:not(.has){
  background: #0f172a;
  border-color: #334155;
  color: #e5eefc;
}
/* ===== Dark mode: richer blue–green calendar ===== */
:is(html,body).is-dark{
  /* cell bg token used by halo + cells */
  --month-cell-bg: rgba(10, 18, 28, .92); /* deep blue-green */
}

:is(html,body).is-dark body[data-view='month'] {
  .p-monthview{
    /* base wash: blue->teal vertical blend */
    background:
      linear-gradient(180deg, #0b1220 0%, #0b1c28 55%, #0a2022 100%);
    border-color: rgba(126, 160, 200, .20);
    box-shadow: 0 14px 36px rgba(0,0,0,.55);

    /* soft static blobs (cool hues) */
    &::before{
      background:
        linear-gradient(180deg, rgba(12,18,32,.22), rgba(10,16,28,.18)),
        radial-gradient(40% 40% at 12% 10%,  rgba(64, 200, 173, .22) 0%, rgba(64,200,173,0) 62%), /* mint-teal */
        radial-gradient(44% 44% at 90% 8%,   rgba(110, 170, 255, .26) 0%, rgba(110,170,255,0) 62%), /* sky blue */
        radial-gradient(58% 58% at 102% 58%, rgba(86, 190, 255, .20) 0%, rgba(86,190,255,0) 64%),   /* cyan */
        radial-gradient(62% 62% at -2% 100%, rgba(41, 171, 135, .22) 0%, rgba(41,171,135,0) 70%);  /* green */
    }

    /* moving glow blobs (cooler, a bit brighter) */
    &::after{
      opacity:.85;
      background:
        radial-gradient(22% 22% at 18% 25%,  rgba(71, 181, 255, .20) 0%, rgba(71,181,255,0) 70%),
        radial-gradient(18% 18% at 78% 22%,  rgba(79, 230, 199, .22) 0%, rgba(79,230,199,0) 70%),
        radial-gradient(24% 24% at 78% 78%,  rgba(84, 160, 255, .18) 0%, rgba(84,160,255,0) 70%),
        radial-gradient(20% 20% at 22% 82%,  rgba(42, 186, 150, .20) 0%, rgba(42,186,150,0) 70%);
    }
  }

  .p-monthhead .p-monthtitle{ color:#e7f1ff; }

  /* week bar: steel-blue to deep-teal */
  .p-weekbar{
    background: linear-gradient(180deg, #0f1b2a 0%, #0a2230 100%);
    border-color: #2a4e6c;
    .p-wday{ color:#a8c9ea; }
  }

  /* cells: subtle blue-green tint + stronger depth */
  .p-cell{
    border-color:#2f4f74;
    background: var(--month-cell-bg);
    box-shadow: 0 3px 16px rgba(4, 10, 20, .65);
  }
  .p-cell__num{ color:#e6f0ff; }

  /* task pill keeps your vars; halo uses the updated --month-cell-bg automatically */
  .p-count{
    background: var(--task-pill-bg, #FFE067);
    border: 1px solid var(--task-pill-border, #f3c340);
    color:#0f172a;
    box-shadow:
      0 0 0 3px var(--month-cell-bg),      /* halo to separate from today ring */
      0 4px 12px rgba(0,0,0,.55);
  }

  /* zero-state pill in dark (readable) */
  .p-count:not(.has){
    background:#0f172a; border-color:#334155; color:#e5eefc;
  }

  /* today ring stays warm to pop on cool bg */
  .p-cell--today::after{
    box-shadow: 0 0 0 var(--month-ring-thickness) #ff6a55 inset;
  }
}
